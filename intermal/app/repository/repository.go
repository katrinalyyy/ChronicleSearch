package repository

import (
	"fmt"
	"strings"
)

type Repository struct {
}

func NewRepository() (*Repository, error) {
	return &Repository{}, nil
}

type Order struct { // вот наша новая структура
	ID             int    // поля структур, которые передаются в шаблон
	Image          string // ключ изображения в MinIO
	ImageKey       string // латинский ключ для MinIO
	Title          string // ОБЯЗАТЕЛЬНО должны быть написаны с заглавной буквы (то есть публичными)
	Author         string
	DateOfCreation string
	TimeOfAction   string
	Location       string
	Description    string
	Significance   string
	Editions       string
	Quote          string
	IsMatched      bool
}

func (r *Repository) GetOrders() ([]Order, error) {
	// имитируем работу с БД. Типа мы выполнили sql запрос и получили эти строки из БД
	orders := []Order{ // массив элементов из наших структур
		{
			ID: 1,
			// Image:          "/static/img/povest_vremen_let.png",
			Image:          "http://127.0.0.1:9000/books/povest_vremen_let.png",
			ImageKey:       "povest-vremennykh-let.png",
			Title:          "Повесть времененных лет",
			Author:         "Нестор Летописец",
			DateOfCreation: "1110 - 1118",
			TimeOfAction:   "852 - 1117",
			Location:       "Киевская Русь",
			Description:    "«Повесть временных лет» — наиболее ранний из дошедших до нас древнерусских летописных сводов начала XII века. Летопись вобрала в себя в большом количестве материалы сказаний, повестей, легенд, устные поэтические предания о различных исторических лицах и событиях. Охватывает период с библейских времён до 1117 года и считается одним из важнейших источников по истории Древней Руси. Традиционно авторство приписывается монаху Киево-Печерского монастыря Нестору, однако современные исследователи полагают, что летопись создавалась несколькими авторами.",
			Significance:   "Летопись содержит древнейшие сведения о происхождении Руси, призвании варягов, крещении князя Владимира, походах против Византии и хазар. В ней впервые упоминаются многие города: Новгород, Полоцк, Ростов, Муром, Белоозеро и другие.",
			Editions:       "Лаврентьевская (1377) - древнейший полный список\n Ипатьевская (начало XV в.) - содержит уникальные сведения\n Радзивилловская (XV в.) - иллюстрированный список",
		},
		{
			ID: 2,
			// Image:          "/static/img/novgorod.png",
			Image:          "http://127.0.0.1:9000/books/troick.png",
			ImageKey:       "novgorod.png",
			Title:          "Новгородская первая летопись",
			Author:         "большинство неизвестно",
			DateOfCreation: "XIII - XV",
			TimeOfAction:   "1016 - 1471",
			Location:       "Новгород",
			Description:    "Новгородская первая летопись — древнерусский летописный свод, отражающий историю Новгорода Великого и северо-западных земель Руси. Создавалась в XIII-XIV веках в Новгороде, представляет собой уникальный источник по истории Новгородской республики. Отличается от киевского летописания более демократическим характером и вниманием к городской жизни, торговле и ремеслам.",
			Significance:   "Летопись содержит уникальные сведения о политическом устройстве Новгородской республики, взаимоотношениях с князьями, торговых связях с Ганзой и Византией. Важнейший источник по истории борьбы Новгорода с крестоносцами, включая Ледовое побоище 1242 года. Освещает события, связанные с деятельностью Александра Невского, а также монгольское нашествие с новгородской точки зрения.",
			Editions:       "Синодальный список (XIII-XIV вв.) - древнейшая редакция, частично утрачена\n Комиссионный список (XV в.) - наиболее полный и исправный текст\n Академический список (XV в.) - содержит дополнительные известия",
		},
		{
			ID: 3,
			// Image:          "/static/img/lavrentiv.png",
			Image:          "http://127.0.0.1:9000/books/lavrentiv.png",
			ImageKey:       "lavrentiv.png",
			Title:          "Лаврентьевская летопись",
			Author:         "Лаврентий",
			DateOfCreation: "1377",
			TimeOfAction:   "1111 - 1305",
			Location:       "Суздаль",
			Description:    "Лаврентьевская летопись — древнерусский летописный свод, переписанный в 1377 году монахом Лаврентием по заказу суздальско-нижегородского князя Дмитрия Константиновича. Представляет собой северо-восточную (суздальскую) версию общерусского летописания. Охватывает период с древнейших времен до 1305 года, является одним из важнейших источников по истории Владимиро-Суздальского княжества.",
			Significance:   "Содержит подробные сведения о становлении Московского княжества, деятельности Андрея Боголюбского, Всеволода Большое Гнездо. Важнейший источник по истории монгольского нашествия, взаимоотношений русских князей с Ордой. Включает уникальную информацию о строительстве городов, храмов, политических событиях северо-восточной Руси.",
			Editions:       "Лаврентьевский список (1377) - основной список, хранится в РНБ\n Радзивилловская летопись (XV в.) - иллюстрированная версия с миниатюрами\n Московско-Академическая летопись (XV в.) - московская переработка",
		},
		{
			ID: 4,
			// Image:          "/static/img/galic.png",
			Image:          "http://127.0.0.1:9000/books/galic.png",
			ImageKey:       "lavgalicrentiv.png",
			Title:          "Галицко-Волынская летопись",
			Author:         "неизвестны",
			DateOfCreation: "XIII",
			TimeOfAction:   "1201—1291",
			Location:       "Галич-Волынь",
			Description:    "Галицко-Волынская летопись — памятник древнерусского летописания XIII века, освещающий историю юго-западной Руси. Создавалась при дворе галицко-волынских князей, прежде всего Даниила Романовича Галицкого. Отличается высоким литературным уровнем, яркими характеристиками исторических деятелей и подробным описанием военных действий.",
			Significance:   "Единственный подробный источник по истории Галицко-Волынского княжества в период монгольского нашествия. Содержит уникальные сведения о европейской политике русских князей, отношениях с Польшей, Венгрией, Литвой. Важен для понимания процессов формирования украинской государственности и культуры. Описывает коронацию Даниила Галицкого как короля Руси.",
			Editions:       "Ипатьевский список (начало XV в.) - основная редакция в составе Ипатьевской летописи\n Хлебниковский список (XVI в.) - дополнительная редакция с вариантами\n Погодинский список (XVII в.) - поздний список с искажениями",
		},
		{
			ID: 5,
			// Image:          "/static/img/pscov.png",
			Image:          "http://127.0.0.1:9000/books/pscov.png",
			ImageKey:       "pscov.png",
			Title:          "Псковские летописи",
			Author:         "неизвестны",
			DateOfCreation: "XIV - XVI",
			TimeOfAction:   "XIII - XVI",
			Location:       "Псков",
			Description:    "Псковские летописи — группа древнерусских летописных памятников XIV-XVI веков, созданных в Пскове. Отражают историю Псковской республики, ее политическое устройство, взаимоотношения с Новгородом, Москвой, Литвой и Ливонским орденом. Характеризуются лаконичностью изложения и точностью в передаче местных событий.",
			Significance:   "Важнейший источник по истории Псковской вечевой республики, ее демократических институтов. Содержит подробные сведения о борьбе с немецкими рыцарями, осадах Пскова, торговых отношениях. Освещает процесс присоединения Пскова к Московскому государству в 1510 году. Уникальный материал по истории северо-западных рубежей Руси.",
			Editions:       "Первая Псковская летопись (XV в.) - древнейшая редакция\n Вторая Псковская летопись (XV-XVI вв.) - наиболее подробная\n Третья Псковская летопись (XVI в.) - краткая редакция",
		},
		{
			ID: 6,
			// Image:          "/static/img/troick.png",
			Image:          "http://127.0.0.1:9000/books/troick.png",
			ImageKey:       "troick.png",
			Title:          "Троицкая летопись",
			Author:         "Епифаний Премудрый",
			DateOfCreation: "XV",
			TimeOfAction:   "XIV - XV",
			Location:       "Москва",
			Description:    "Троицкая летопись — московский летописный свод начала XV века, составленный в Троице-Сергиевом монастыре. Погибла в московском пожаре 1812 года, известна по выпискам Н.М. Карамзина. Представляла собой официальную московскую версию русской истории, отражавшую политические интересы московских князей и их стремление к объединению русских земель.",
			Significance:   "Первый целостный московский летописный свод, обосновывавший права московских князей на общерусское наследство. Содержала подробные сведения о Куликовской битве, деятельности Дмитрия Донского, Сергия Радонежского. Важна для понимания идеологии московского центра, процессов централизации и формирования российской государственности.",
			Editions:       "Троицкая летопись (начало XV в.) - основной текст (утрачен)\n Симеоновская летопись (XV в.) - близкий к Троицкой текст\n Рогожский летописец (XV в.) - параллельная редакция",
		},
	}
	// обязательно проверяем ошибки, и если они появились - передаем выше, то есть хендлеру
	// тут я снова искусственно обработаю "ошибку" чисто чтобы показать вам как их передавать выше
	if len(orders) == 0 {
		return nil, fmt.Errorf("массив пустой")
	}

	return orders, nil
}

func (r *Repository) GetOrder(id int) (Order, error) {
	// тут у вас будет логика получения нужной услуги, тоже наверное через цикл в первой лабе, и через запрос к БД начиная со второй
	orders, err := r.GetOrders()
	if err != nil {
		return Order{}, err // тут у нас уже есть кастомная ошибка из нашего метода, поэтому мы можем просто вернуть ее
	}

	for _, order := range orders {
		if order.ID == id {
			return order, nil // если нашли, то просто возвращаем найденный заказ (услугу) без ошибок
		}
	}
	return Order{}, fmt.Errorf("заказ не найден") // тут нужна кастомная ошибка, чтобы понимать на каком этапе возникла ошибка и что произошло
}

func (r *Repository) GetOrdersByTitle(title string) ([]Order, error) {
	orders, err := r.GetOrders()
	if err != nil {
		return []Order{}, err
	}

	var result []Order
	for _, order := range orders {
		if strings.Contains(strings.ToLower(order.Title), strings.ToLower(title)) {
			result = append(result, order)
		}
	}

	return result, nil
}

type Cart struct {
	Components  []Order
	SearchEvent string
	Event       string
}

func (r *Repository) GetCart() (Cart, error) {
	order1, err := r.GetOrder(1)
	if err != nil {
		return Cart{}, err
	}
	order1.Quote = "Владимир крести всю землю Русскую"
	order1.IsMatched = true

	order6, err := r.GetOrder(6)
	if err != nil {
		return Cart{}, err
	}
	order6.Quote = "Епифаний Премудрый написа житие святых"
	order6.IsMatched = false

	order4, err := r.GetOrder(4)
	if err != nil {
		return Cart{}, err
	}
	order4.Quote = "Данило князь венча ся короною"
	order4.IsMatched = false

	cart := Cart{
		Components:  []Order{order1, order6, order4},
		SearchEvent: "крести всю землю",
		Event:       "Крещение Руси",
	}

	return cart, nil
}
